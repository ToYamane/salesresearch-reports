<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>営業リサーチレポート一覧</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* 追加のインラインスタイル */
    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--danger);
    }
    .filter-bar {
      max-width: 1200px;
      margin: 0 auto 1rem;
      padding: 0 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-bar .search-group {
      flex: 1;
      min-width: 200px;
    }
    .filter-bar label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    .filter-bar input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .filter-bar input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .filter-bar .sort-group {
      min-width: 160px;
    }
    .filter-bar select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      font-size: 0.95rem;
      background: var(--bg-white);
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .filter-bar select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .report-count {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }
    .pagination {
      max-width: 1200px;
      margin: 1.5rem auto;
      padding: 0 1.5rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .pagination button {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      background: var(--bg-white);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pagination button:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .pagination button.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- ヘッダー -->
  <header class="report-list-header">
    <h1>営業リサーチレポート一覧</h1>
    <p>生成されたレポートの履歴を閲覧できます</p>
  </header>

  <!-- 検索フィルター & ソート -->
  <div class="filter-bar">
    <div class="search-group">
      <label for="searchInput">検索</label>
      <input type="text" id="searchInput" placeholder="人物名・会社名・商材名で検索..." oninput="filterReports()">
    </div>
    <div class="sort-group">
      <label for="sortSelect">並び替え</label>
      <select id="sortSelect" onchange="sortReports()">
        <option value="date-desc">日付（新しい順）</option>
        <option value="date-asc">日付（古い順）</option>
        <option value="name-asc">名前順（A→Z）</option>
        <option value="name-desc">名前順（Z→A）</option>
        <option value="score-desc">スコア順（高→低）</option>
        <option value="score-asc">スコア順（低→高）</option>
      </select>
    </div>
  </div>

  <!-- レポート件数 -->
  <div class="report-count" id="reportCount" aria-live="polite"></div>

  <!-- レポート一覧 -->
  <main id="reportList" class="report-grid">
    <div class="loading" role="status" aria-label="読み込み中">
      <div class="loading-spinner"></div>
      <p>レポート一覧を読み込み中...</p>
    </div>
  </main>

  <!-- ページネーション -->
  <div class="pagination" id="pagination" aria-label="ページナビゲーション"></div>

  <!-- フッター -->
  <footer style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.85rem;">
    <p>営業リサーチ自動化システム</p>
  </footer>

  <script>
    let allReports = [];
    let filteredReports = [];
    const ITEMS_PER_PAGE = 20;
    let currentPage = 1;

    // レポート一覧を取得
    async function loadReports() {
      const reportList = document.getElementById('reportList');

      try {
        const response = await fetch('reports.json?t=' + Date.now());
        if (!response.ok) {
          throw new Error('レポート一覧の取得に失敗しました');
        }

        const data = await response.json();
        allReports = data.reports || [];

        // デフォルトソート（日付の新しい順）
        allReports.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        filteredReports = allReports;
        currentPage = 1;
        renderPage(currentPage);
      } catch (error) {
        console.error('Error loading reports:', error);
        reportList.innerHTML = `
          <div class="error-state" style="grid-column: 1 / -1;">
            <p>通信エラーが発生しました。</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--text-muted);">
              レポートがまだないか、通信に問題がある可能性があります。<br>
              /research コマンドでレポートを生成してください。
            </p>
          </div>
        `;
        updateCount(0);
      }
    }

    // ソート実行
    function sortReports() {
      const sortValue = document.getElementById('sortSelect').value;

      filteredReports.sort((a, b) => {
        switch (sortValue) {
          case 'date-desc':
            return new Date(b.created_at) - new Date(a.created_at);
          case 'date-asc':
            return new Date(a.created_at) - new Date(b.created_at);
          case 'name-asc':
            return (a.person_name || '').localeCompare(b.person_name || '', 'ja');
          case 'name-desc':
            return (b.person_name || '').localeCompare(a.person_name || '', 'ja');
          case 'score-desc': {
            const scoreA = getTopScore(a);
            const scoreB = getTopScore(b);
            return scoreB - scoreA;
          }
          case 'score-asc': {
            const scoreA2 = getTopScore(a);
            const scoreB2 = getTopScore(b);
            return scoreA2 - scoreB2;
          }
          default:
            return 0;
        }
      });

      currentPage = 1;
      renderPage(currentPage);
    }

    // 最高スコアを取得
    function getTopScore(report) {
      if (report.top_products && report.top_products.length > 0) {
        return Math.max(...report.top_products.map(p => p.score || 0));
      }
      return 0;
    }

    // 指定ページを描画
    function renderPage(page) {
      const totalPages = Math.ceil(filteredReports.length / ITEMS_PER_PAGE);
      currentPage = Math.max(1, Math.min(page, totalPages || 1));

      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageReports = filteredReports.slice(start, end);

      renderReports(pageReports);
      renderPagination(totalPages);
      updateCount(filteredReports.length);
    }

    // レポートを描画
    function renderReports(reports) {
      const reportList = document.getElementById('reportList');

      if (reports.length === 0 && filteredReports.length === 0) {
        reportList.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <p>該当するレポートが見つかりません。</p>
          </div>
        `;
        return;
      }

      reportList.innerHTML = reports.map(report => {
        const createdDate = new Date(report.created_at);
        const dateStr = createdDate.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const timeStr = createdDate.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit'
        });

        // 商材TOP5を表示
        let productsHtml = '';
        if (report.top_products && report.top_products.length > 0) {
          const productItems = report.top_products.map((p, index) => {
            const rankClass = index < 3 ? `rank-${index + 1}` : '';
            return `
              <li class="card-product-item ${rankClass}">
                <span class="card-product-rank">${index + 1}</span>
                <span class="card-product-name">${escapeHtml(p.name)}</span>
                <span class="card-product-score">${p.score}/30</span>
              </li>
            `;
          }).join('');
          productsHtml = `
            <div class="card-products">
              <div class="card-products-title">推奨商材</div>
              <ol class="card-products-list">${productItems}</ol>
            </div>
          `;
        }

        return `
          <a href="reports/${report.id}.html" class="report-list-card">
            <div class="person-name">${escapeHtml(report.person_name)} 様</div>
            <div class="company-name">${escapeHtml(report.company_name)}</div>
            ${productsHtml}
            <div class="report-date">${dateStr} ${timeStr}</div>
          </a>
        `;
      }).join('');
    }

    // ページネーション描画
    function renderPagination(totalPages) {
      const pagination = document.getElementById('pagination');

      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let html = '';

      // 前へボタン
      html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="renderPage(${currentPage - 1})">&laquo; 前へ</button>`;

      // ページ番号
      for (let i = 1; i <= totalPages; i++) {
        if (totalPages <= 7 || i === 1 || i === totalPages || Math.abs(i - currentPage) <= 1) {
          html += `<button class="${i === currentPage ? 'active' : ''}" onclick="renderPage(${i})">${i}</button>`;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          html += `<button disabled>...</button>`;
        }
      }

      // 次へボタン
      html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="renderPage(${currentPage + 1})">次へ &raquo;</button>`;

      pagination.innerHTML = html;
    }

    // 検索フィルター（商材名も検索対象に含む）
    function filterReports() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      filteredReports = allReports.filter(report => {
        const personName = (report.person_name || '').toLowerCase();
        const companyName = (report.company_name || '').toLowerCase();
        // 商材名も検索対象に含む
        let productNames = '';
        if (report.top_products) {
          productNames = report.top_products.map(p => (p.name || '').toLowerCase()).join(' ');
        }
        return personName.includes(searchTerm) || companyName.includes(searchTerm) || productNames.includes(searchTerm);
      });

      // 現在のソートを維持
      sortReports();
    }

    // 件数を更新
    function updateCount(count) {
      const countEl = document.getElementById('reportCount');
      countEl.textContent = `${count}件のレポート`;
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 初期読み込み
    document.addEventListener('DOMContentLoaded', loadReports);
  </script>
</body>
</html>
